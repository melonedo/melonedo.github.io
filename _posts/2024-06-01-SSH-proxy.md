---
layout: post
title: SSH 代理配置
date: 2024-06-01 12:21:00 +0800
tags: 
- 编程
render_with_liquid: false
---

SSH 连接是非常方便的连接形式，同时还支持在各设备间建立加密通道，也就是建立代理。在[使用 SSH 服务打破网络边界](https://blog.xlab.qianxin.com/li-yong-ssh/)文章里讲得很好，这里总结一下，加上 .ssh/config 里的配置方法。

## 正向代理

一般使用时常见需要在本地访问远程设备的场景，比如本地访问远程服务器所在网络中的服务。

```shell
ssh -L localport:remoteaddress:remoteport user@remote
```

此时本地访问 localport 时，ssh 会转发到远程上去访问 remoteaddress:remoteport。如果 remoteaddress 是 localhost，可以不写，如`-L 1234::1235`，本地访问 1234 端口时会访问远程的 1235 端口。

## 反向代理

反过来，如果远程想访问本地的服务，可以设置反向代理。

```shell
ssh -R remoteport:localaddress:localport user@remote
```

此时，在远程上访问 remoteport 时会转发到本地。

注：此时本地收到的连接可能来自 IPv6 本地链接地址（fe80::/10），而不是回环地址（::1/128）。

## SSH 跳板

一个很常见的场景是用 SSH 代理 SSH，即有两台机器 A 和 B，其中本地可以访问 A 但本地不能访问 B，而 A 可以访问到 B。

这种情况下，可以连接到 A 后建立正向代理，转发 B 的 SSH 端口到本地，再连接到该端口。而 SSH 针对这一情况已经进行简化，可以直接使用下列指令以 A 作为跳板访问 B。

```shell
ssh -J user@A user@B
```

## ssh_config

以上设置可以直接在 .ssh/config 中配置，省去每次输入一大串指令的麻烦。

- `-L localport:remoteaddress:remoteport`对应 `LocalForward localport remoteaddress:remoteport`。
和命令行参数的区别是第一个端口号和后面的地址间用空格而不是冒号隔开。
- `-R remoteport:localaddress:localport`对应`RemoteForward remoteport localaddress:localport`。
- `-J A`对应`ProxyJump A`。